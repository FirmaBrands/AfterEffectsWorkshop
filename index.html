<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AE Workshop Vote</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        ae: {
                            dark: '#12121c',
                            card: '#1e1e2f',
                            purple: '#9e8cfc',
                            blue: '#4a90e2'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0d0d12;
            color: #e2e2e2;
        }
        .vote-card {
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .vote-card:hover {
            transform: translateY(-2px);
            border-color: rgba(158, 140, 252, 0.3);
        }
        .vote-card.selected {
            border-color: #9e8cfc;
            background-color: rgba(158, 140, 252, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #6a5acd 0%, #9e8cfc 100%);
        }
        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #9e8cfc;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="py-12 px-6 text-center bg-gradient-to-b from-ae-card to-transparent">
        <div class="max-w-4xl mx-auto">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-[#00005a] text-[#dcbaff] text-3xl font-bold mb-6 shadow-lg border border-[#302d69]">
                Ae
            </div>
            <h1 class="text-4xl md:text-5xl font-bold mb-4 bg-clip-text text-transparent bg-gradient-to-r from-white to-gray-400">
                After Effects Workshop
            </h1>
            <p class="text-gray-400 text-lg max-w-2xl mx-auto">
                I'm planning a workshop to level up our motion skills. Help me tailor the content by voting on what you want to learn most.
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow px-6 pb-12">
        <div class="max-w-4xl mx-auto">
            
            <!-- Auth Loading State -->
            <div id="auth-loading" class="flex justify-center py-12">
                <div class="loader"></div>
            </div>

            <div id="app-content" class="hidden space-y-12">
                
                <!-- Topic Voting Section -->
                <section>
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-white"><i class="fas fa-poll text-ae-purple mr-2"></i> Vote for Topics</h2>
                        <span class="text-sm text-gray-500">Select all that apply</span>
                    </div>

                    <div id="topics-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Topics injected by JS -->
                    </div>
                </section>

                <!-- Suggestions Section -->
                <section class="bg-ae-card rounded-xl p-6 md:p-8 border border-white/5">
                    <h2 class="text-2xl font-bold text-white mb-2"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i> Something else?</h2>
                    <p class="text-gray-400 mb-6">If you have a specific request or a project file you want to deconstruct, let me know.</p>
                    
                    <form id="suggestion-form" class="space-y-4">
                        <div>
                            <textarea 
                                id="suggestion-input" 
                                rows="3" 
                                class="w-full bg-[#12121c] border border-gray-700 rounded-lg p-4 text-white focus:outline-none focus:border-ae-purple transition-colors placeholder-gray-600"
                                placeholder="e.g., How to export transparent JSONs for Lottie..."
                                required
                            ></textarea>
                        </div>
                        <div class="flex items-center justify-between">
                            <span id="form-status" class="text-sm font-medium opacity-0 transition-opacity duration-300">Sent!</span>
                            <button type="submit" class="btn-primary px-6 py-2 rounded-lg font-semibold text-white shadow-lg hover:opacity-90 transition-opacity flex items-center gap-2">
                                <span>Submit Suggestion</span>
                                <i class="fas fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Recent Suggestions Feed -->
                    <div class="mt-8 pt-8 border-t border-gray-800">
                        <h3 class="text-sm uppercase tracking-wider text-gray-500 font-semibold mb-4">Recent Suggestions</h3>
                        <div id="suggestions-list" class="space-y-3">
                            <!-- Suggestions injected by JS -->
                        </div>
                    </div>
                </section>
            </div>

        </div>
    </main>

    <footer class="py-8 text-center text-gray-600 text-sm">
        <p>Built for the Design Team</p>
    </footer>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, arrayUnion, arrayRemove, onSnapshot, addDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAubPtprKuQ_ky5AAboUbZHtu4AFbNVHqA",
            authDomain: "ae-workshop.firebaseapp.com",
            projectId: "ae-workshop",
            storageBucket: "ae-workshop.firebasestorage.app",
            messagingSenderId: "996938664906",
            appId: "1:996938664906:web:cc1277c3a33f0d93e59d33"
        };

        // --- App State ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- Static Topics Definition ---
        // We define these here to keep the structure simple. 
        // We will store votes in Firestore under these IDs.
        const TOPICS = [
            {
                id: "lottie_export",
                title: "Lottie & Rive Export",
                desc: "Preparing vectors, avoiding unsupported features, and handing off JSONs to dev."
            },
            {
                id: "ui_interaction",
                title: "Micro-interactions & UX",
                desc: "Prototyping button states, loaders, and transitions with proper easing."
            },
            {
                id: "track_comp",
                title: "Screen Replacement",
                desc: "Basic motion tracking to put UI designs onto stock footage of devices."
            },
            {
                id: "text_anim",
                title: "Typography Animation",
                desc: "Using text animators effectively without manual keyframing."
            },
            {
                id: "essential_graphics",
                title: "Templates (MOGRTs)",
                desc: "Building reusable templates for social media or recurring headers."
            },
            {
                id: "workflow",
                title: "Workflow & Speed",
                desc: "Shortcuts, graph editor mastery, and essential plugins."
            }
        ];

        // --- DOM Elements ---
        const ui = {
            loading: document.getElementById('auth-loading'),
            content: document.getElementById('app-content'),
            grid: document.getElementById('topics-grid'),
            form: document.getElementById('suggestion-form'),
            input: document.getElementById('suggestion-input'),
            status: document.getElementById('form-status'),
            suggestionsList: document.getElementById('suggestions-list')
        };

        // --- Initialization ---
        async function init() {
            // 1. Authenticate silently
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Could not sign in. Check console.");
            }
        }

        // --- Auth Listener & Main Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                ui.loading.classList.add('hidden');
                ui.content.classList.remove('hidden');
                
                setupRealtimeListeners();
            }
        });

        // --- Realtime Data Handling ---
        function setupRealtimeListeners() {
            // 1. Listen to Topics/Votes
            // We use a single collection 'public/data/topic_votes' to store vote arrays
            const topicsRef = collection(db, 'artifacts', 'ae-workshop', 'public', 'data', 'topic_votes');
            
            onSnapshot(collection(db, 'artifacts', 'ae-workshop', 'public', 'data', 'topic_votes'), (snapshot) => {
                const voteData = {};
                snapshot.forEach(doc => {
                    voteData[doc.id] = doc.data().voters || [];
                });
                renderTopics(voteData);
            }, (error) => {
                // If collection doesn't exist yet, we render with 0 votes
                if(error.code === 'permission-denied') {
                     console.error("Permission denied. Check Firestore Rules.");
                } else {
                     renderTopics({});
                }
            });

            // 2. Listen to Suggestions
            const suggestionsQuery = query(
                collection(db, 'artifacts', 'ae-workshop', 'public', 'data', 'suggestions'), 
                orderBy('timestamp', 'desc'), 
                limit(10)
            );
            
            onSnapshot(suggestionsQuery, (snapshot) => {
                ui.suggestionsList.innerHTML = '';
                if(snapshot.empty) {
                    ui.suggestionsList.innerHTML = '<p class="text-gray-600 italic text-sm">No suggestions yet. Be the first!</p>';
                    return;
                }
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const el = document.createElement('div');
                    el.className = 'bg-[#181824] p-3 rounded text-gray-300 text-sm border-l-2 border-ae-purple';
                    el.innerText = data.text;
                    ui.suggestionsList.appendChild(el);
                });
            });
        }

        // --- Rendering ---
        function renderTopics(voteData) {
            ui.grid.innerHTML = '';
            
            TOPICS.forEach(topic => {
                const voters = voteData[topic.id] || [];
                const count = voters.length;
                const hasVoted = voters.includes(currentUser.uid);

                const card = document.createElement('div');
                card.className = `vote-card relative bg-ae-card rounded-xl p-5 cursor-pointer select-none group ${hasVoted ? 'selected' : ''}`;
                card.onclick = () => toggleVote(topic.id, hasVoted);

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-white group-hover:text-ae-purple transition-colors">${topic.title}</h3>
                        <div class="flex items-center space-x-2 ${hasVoted ? 'text-ae-purple' : 'text-gray-500'}">
                            <span class="text-xl font-bold">${count}</span>
                            <i class="${hasVoted ? 'fas' : 'far'} fa-heart"></i>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm leading-relaxed">${topic.desc}</p>
                    ${hasVoted ? '<div class="absolute inset-0 border-2 border-ae-purple rounded-xl pointer-events-none opacity-50"></div>' : ''}
                `;
                ui.grid.appendChild(card);
            });
        }

        // --- Actions ---
        
        // Toggle Vote
        window.toggleVote = async (topicId, currentlyVoted) => {
            if (!currentUser) return;
            
            const topicRef = doc(db, 'artifacts', 'ae-workshop', 'public', 'data', 'topic_votes', topicId);
            
            try {
                // We use arrayUnion/arrayRemove to ensure atomic updates without overwriting others
                await setDoc(topicRef, {
                    voters: currentlyVoted ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid)
                }, { merge: true });
            } catch (e) {
                console.error("Error voting:", e);
            }
        };

        // Submit Suggestion
        ui.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = ui.input.value.trim();
            if (!text || !currentUser) return;

            const btn = ui.form.querySelector('button');
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<div class="loader w-4 h-4 border-white"></div>';
            btn.disabled = true;

            try {
                await addDoc(collection(db, 'artifacts', 'ae-workshop', 'public', 'data', 'suggestions'), {
                    text: text,
                    uid: currentUser.uid,
                    timestamp: serverTimestamp()
                });

                ui.input.value = '';
                ui.status.style.color = '#4ade80'; // Green
                ui.status.innerText = "Thanks for the feedback!";
                ui.status.style.opacity = '1';
                
                setTimeout(() => { ui.status.style.opacity = '0'; }, 3000);
            } catch (error) {
                console.error("Error submitting:", error);
                ui.status.style.color = '#f87171'; // Red
                ui.status.innerText = "Error. Try again.";
                ui.status.style.opacity = '1';
            } finally {
                btn.innerHTML = originalBtnContent;
                btn.disabled = false;
            }
        });

        // Run Init
        init();

    </script>
</body>
</html>
