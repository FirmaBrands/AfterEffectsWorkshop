<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After Effects Workshop | Team Vote</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ae: {
                            dark: '#0f0f1d', // Deep AE interface gray
                            panel: '#1f1f2e',
                            purple: '#cf8bf3', // AE logo purple
                            blue: '#4c96ff',
                            text: '#e6e6e6'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f0f1d; color: #e6e6e6; }
        .glass-panel {
            background: rgba(31, 31, 46, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f1d; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import React from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC6gjDkHHsh9ru3PFHJVJAZpGIvQWja96o",
            authDomain: "aftereffectsworkshop-ab75f.firebaseapp.com",
            projectId: "aftereffectsworkshop-ab75f",
            storageBucket: "aftereffectsworkshop-ab75f.firebasestorage.app",
            messagingSenderId: "522266658938",
            appId: "1:522266658938:web:f4531315cc8e7c8cc413c3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Determine App ID for pathing (using a fixed ID for your workshop)
        const WORKSHOP_ID = "ae-workshop-2025"; 
        
        // --- React Components ---

        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const iconName = name.charAt(0).toUpperCase() + name.slice(1);
            const Icon = window.lucide && window.lucide.icons ? window.lucide.icons[iconName] : null;
            if (!Icon) return null;
            
            // Create a React element from the Lucide icon
            return React.createElement('svg', {
                ...Icon,
                width: size,
                height: size,
                className: className,
                stroke: "currentColor",
                strokeWidth: 2,
                strokeLinecap: "round",
                strokeLinejoin: "round",
                dangerouslySetInnerHTML: { __html: window.lucide.createIcons({ icons: { [iconName]: Icon }, attrs: { class: "hidden" } }) ? '' : '' } // Lucide generic render hack for raw SVG
            });
        };

        // Simpler Icon wrapper since the above is complex with CDN
        const Icon = ({ name, className }) => {
            React.useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const PRESET_TOPICS = [
            "UI Animation Principles",
            "Lottie / Web Export",
            "3D Tracking & Composition",
            "Micro-interactions",
            "Character Rigging (Duik/Rubberhose)",
            "Text Animation & Typography",
            "Expressions & Scripting",
            "Rotoscoping",
            "Motion Branding"
        ];

        const SKILL_LEVELS = [
            { id: 'beginner', label: 'Beginner', desc: 'I open AE by accident sometimes.' },
            { id: 'intermediate', label: 'Intermediate', desc: 'I can keyframe, but graphs are scary.' },
            { id: 'advanced', label: 'Advanced', desc: 'I dream in Bezier curves.' }
        ];

        function App() {
            const [user, setUser] = React.useState(null);
            const [hasVoted, setHasVoted] = React.useState(false);
            const [loading, setLoading] = React.useState(true);
            const [ballots, setBallots] = React.useState([]);
            
            // Form State
            const [skill, setSkill] = React.useState('');
            const [selectedTopics, setSelectedTopics] = React.useState([]);
            const [customTopic, setCustomTopic] = React.useState('');
            const [submitting, setSubmitting] = React.useState(false);

            // Auth & Check Local Storage
            React.useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser);
                    if (!currentUser) {
                        signInAnonymously(auth).catch(console.error);
                    }
                });

                const localVote = localStorage.getItem(`voted_${WORKSHOP_ID}`);
                if (localVote) setHasVoted(true);

                return () => unsubscribe();
            }, []);

            // Fetch Data
            React.useEffect(() => {
                if (!user) return;
                
                // Using the requested Artifacts path structure
                const ballotsRef = collection(db, 'artifacts', WORKSHOP_ID, 'public', 'data', 'ballots');
                const q = query(ballotsRef);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setBallots(data);
                    setLoading(false);
                }, (error) => {
                    console.error("Error fetching ballots:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user]);

            const handleToggleTopic = (topic) => {
                if (selectedTopics.includes(topic)) {
                    setSelectedTopics(prev => prev.filter(t => t !== topic));
                } else {
                    setSelectedTopics(prev => [...prev, topic]);
                }
            };

            const handleSubmit = async () => {
                if (!skill) return alert("Please select a skill level!");
                if (selectedTopics.length === 0 && !customTopic) return alert("Please pick at least one topic!");

                setSubmitting(true);

                const finalTopics = [...selectedTopics];
                if (customTopic.trim()) finalTopics.push(customTopic.trim());

                try {
                    const ballotsRef = collection(db, 'artifacts', WORKSHOP_ID, 'public', 'data', 'ballots');
                    await addDoc(ballotsRef, {
                        uid: user.uid,
                        skillLevel: skill,
                        topics: finalTopics,
                        timestamp: serverTimestamp()
                    });

                    localStorage.setItem(`voted_${WORKSHOP_ID}`, 'true');
                    setHasVoted(true);
                } catch (e) {
                    console.error("Error submitting vote:", e);
                    alert("Something went wrong. Check console.");
                }
                setSubmitting(false);
            };

            // Calculate Results
            const results = React.useMemo(() => {
                const total = ballots.length;
                if (total === 0) return null;

                const skillCounts = { beginner: 0, intermediate: 0, advanced: 0 };
                const topicCounts = {};

                ballots.forEach(b => {
                    // Count Skills
                    if (skillCounts[b.skillLevel] !== undefined) {
                        skillCounts[b.skillLevel]++;
                    }
                    // Count Topics
                    if (Array.isArray(b.topics)) {
                        b.topics.forEach(t => {
                            topicCounts[t] = (topicCounts[t] || 0) + 1;
                        });
                    }
                });

                const rankedTopics = Object.entries(topicCounts)
                    .sort(([, a], [, b]) => b - a)
                    .map(([name, count]) => ({ name, count }));

                return { total, skillCounts, rankedTopics };

            }, [ballots]);


            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-ae-dark text-ae-purple">
                        <div className="flex flex-col items-center gap-4">
                            <Icon name="loader-2" className="w-8 h-8 animate-spin" />
                            <p className="text-gray-400 text-sm">Loading Workshop Data...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-ae-dark text-gray-200 p-4 md:p-8 font-sans selection:bg-ae-purple selection:text-white pb-20">
                    <div className="max-w-3xl mx-auto">
                        
                        {/* Header */}
                        <header className="mb-12 text-center animate-fade-in">
                            <div className="inline-flex items-center justify-center p-3 bg-ae-panel rounded-2xl mb-4 border border-white/5 shadow-2xl">
                                <span className="bg-[#00005b] text-[#cf8bf3] font-bold px-3 py-1 rounded border border-[#cf8bf3]/30 mr-3">Ae</span>
                                <h1 className="text-xl font-bold tracking-tight text-white">Workshop Wishlist</h1>
                            </div>
                            <p className="text-gray-400 max-w-lg mx-auto">
                                Help tailor the upcoming After Effects sessions. Vote for what you want to learn so we don't bore you with the basics (or overwhelm you with the wizardry).
                            </p>
                        </header>

                        {!hasVoted ? (
                            <div className="space-y-8 animate-fade-in">
                                {/* Skill Section */}
                                <section>
                                    <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                        <span className="flex items-center justify-center w-6 h-6 rounded-full bg-ae-purple text-ae-dark text-xs font-bold">1</span>
                                        What's your current comfort level?
                                    </h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {SKILL_LEVELS.map((lvl) => (
                                            <button
                                                key={lvl.id}
                                                onClick={() => setSkill(lvl.id)}
                                                className={`p-6 rounded-xl border text-left transition-all duration-200 group relative overflow-hidden
                                                    ${skill === lvl.id 
                                                        ? 'bg-ae-purple/10 border-ae-purple shadow-[0_0_20px_rgba(207,139,243,0.15)]' 
                                                        : 'bg-ae-panel border-white/5 hover:border-white/20 hover:bg-white/5'
                                                    }`}
                                            >
                                                <div className="relative z-10">
                                                    <div className="font-bold text-white mb-1">{lvl.label}</div>
                                                    <div className="text-xs text-gray-400 group-hover:text-gray-300">{lvl.desc}</div>
                                                </div>
                                                {skill === lvl.id && (
                                                    <div className="absolute top-2 right-2 text-ae-purple">
                                                        <Icon name="check-circle" className="w-5 h-5" />
                                                    </div>
                                                )}
                                            </button>
                                        ))}
                                    </div>
                                </section>

                                {/* Topics Section */}
                                <section>
                                    <h2 className="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                                        <span className="flex items-center justify-center w-6 h-6 rounded-full bg-ae-purple text-ae-dark text-xs font-bold">2</span>
                                        What do you want to learn?
                                    </h2>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {PRESET_TOPICS.map((topic) => (
                                            <button
                                                key={topic}
                                                onClick={() => handleToggleTopic(topic)}
                                                className={`px-4 py-3 rounded-lg text-sm font-medium transition-all duration-200 border text-left flex justify-between items-center
                                                    ${selectedTopics.includes(topic)
                                                        ? 'bg-ae-blue/20 border-ae-blue text-white shadow-[0_0_15px_rgba(76,150,255,0.1)]'
                                                        : 'bg-ae-panel border-white/5 text-gray-400 hover:text-white hover:border-white/10'
                                                    }`}
                                            >
                                                {topic}
                                                {selectedTopics.includes(topic) && <Icon name="check" className="w-4 h-4 text-ae-blue" />}
                                            </button>
                                        ))}
                                    </div>
                                    
                                    {/* Custom Topic Input */}
                                    <div className="mt-4 pt-4 border-t border-white/5">
                                        <label className="text-xs uppercase tracking-wider text-gray-500 font-semibold mb-2 block">Something else?</label>
                                        <div className="flex gap-2">
                                            <input 
                                                type="text" 
                                                value={customTopic}
                                                onChange={(e) => setCustomTopic(e.target.value)}
                                                placeholder="e.g. Plugin workflows, 3D Element..."
                                                className="flex-1 bg-ae-panel border border-white/10 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-ae-purple focus:ring-1 focus:ring-ae-purple transition-all"
                                            />
                                        </div>
                                    </div>
                                </section>

                                {/* Submit */}
                                <div className="pt-6">
                                    <button
                                        onClick={handleSubmit}
                                        disabled={submitting}
                                        className="w-full py-4 rounded-xl bg-gradient-to-r from-ae-purple to-purple-600 text-white font-bold text-lg shadow-lg hover:shadow-ae-purple/20 hover:scale-[1.01] active:scale-[0.99] transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        {submitting ? (
                                            <>
                                                <Icon name="loader-2" className="w-5 h-5 animate-spin" /> Saving...
                                            </>
                                        ) : (
                                            <>
                                                Submit Vote <Icon name="send" className="w-5 h-5" />
                                            </>
                                        )}
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in space-y-8">
                                {/* Results View */}
                                <div className="text-center p-6 bg-green-500/10 border border-green-500/20 rounded-xl mb-8">
                                    <h2 className="text-xl font-bold text-green-400 mb-1">Vote Recorded!</h2>
                                    <p className="text-sm text-gray-400">Thanks for helping shape the workshop. Here is the current breakdown.</p>
                                </div>

                                <div className="grid md:grid-cols-2 gap-8">
                                    
                                    {/* Skill Breakdown */}
                                    <div className="glass-panel p-6 rounded-2xl">
                                        <h3 className="text-gray-400 text-sm font-semibold uppercase tracking-wider mb-6 flex items-center gap-2">
                                            <Icon name="bar-chart-2" className="w-4 h-4" /> Team Skill Level
                                        </h3>
                                        <div className="space-y-5">
                                            {SKILL_LEVELS.map(lvl => {
                                                const count = results?.skillCounts[lvl.id] || 0;
                                                const pct = results?.total ? (count / results.total) * 100 : 0;
                                                return (
                                                    <div key={lvl.id}>
                                                        <div className="flex justify-between text-sm mb-2">
                                                            <span className="text-white">{lvl.label}</span>
                                                            <span className="text-gray-400">{count} votes</span>
                                                        </div>
                                                        <div className="h-2 w-full bg-black/40 rounded-full overflow-hidden">
                                                            <div 
                                                                className="h-full bg-ae-purple transition-all duration-1000 ease-out" 
                                                                style={{ width: `${pct}%` }}
                                                            ></div>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>

                                    {/* Top Topics */}
                                    <div className="glass-panel p-6 rounded-2xl">
                                        <h3 className="text-gray-400 text-sm font-semibold uppercase tracking-wider mb-6 flex items-center gap-2">
                                            <Icon name="list" className="w-4 h-4" /> Top Requests
                                        </h3>
                                        <div className="space-y-3 max-h-[300px] overflow-y-auto pr-2">
                                            {results?.rankedTopics.length > 0 ? results.rankedTopics.map((topic, i) => (
                                                <div key={topic.name} className="flex items-center gap-3 p-3 rounded-lg bg-white/5 border border-white/5">
                                                    <div className={`
                                                        w-8 h-8 rounded flex items-center justify-center text-sm font-bold
                                                        ${i === 0 ? 'bg-yellow-500 text-black' : 
                                                          i === 1 ? 'bg-gray-400 text-black' : 
                                                          i === 2 ? 'bg-orange-700 text-white' : 'bg-white/10 text-gray-400'}
                                                    `}>
                                                        {i + 1}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-sm font-medium text-white truncate" title={topic.name}>
                                                            {topic.name}
                                                        </div>
                                                    </div>
                                                    <div className="px-2 py-1 rounded bg-black/30 text-xs font-mono text-gray-400">
                                                        {topic.count}
                                                    </div>
                                                </div>
                                            )) : (
                                                <div className="text-gray-500 text-sm italic">No topics voted on yet.</div>
                                            )}
                                        </div>
                                    </div>

                                </div>
                                <div className="text-center pt-8">
                                    <div className="inline-block px-4 py-2 rounded-full bg-white/5 text-xs text-gray-500">
                                        Total Votes: <span className="text-white font-bold">{results?.total || 0}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
