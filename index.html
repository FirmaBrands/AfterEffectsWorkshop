import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from "firebase/app";
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged 
} from "firebase/auth";
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  arrayUnion, 
  arrayRemove, 
  onSnapshot, 
  serverTimestamp,
  deleteDoc
} from "firebase/firestore";
import { 
  Vote, 
  MessageSquarePlus, 
  Plus, 
  Layers, 
  Sparkles, 
  Trash2, 
  ThumbsUp, 
  Check,
  Zap,
  Box,
  Smartphone,
  MousePointer
} from 'lucide-react';

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyAubPtprKuQ_ky5AAboUbZHtu4AFbNVHqA",
  authDomain: "ae-workshop.firebaseapp.com",
  projectId: "ae-workshop",
  storageBucket: "ae-workshop.firebasestorage.app",
  messagingSenderId: "996938664906",
  appId: "1:996938664906:web:cc1277c3a33f0d93e59d33"
};

// --- Initialization ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Use a fallback appId if the global one isn't available
const appId = typeof __app_id !== 'undefined' ? __app_id : 'ae-workshop-default';

// --- Default Suggestions for Quick Add ---
const PRESETS = [
  { title: "UI Micro-interactions", icon: <MousePointer size={18} /> },
  { title: "Lottie & Bodymovin Export", icon: <Zap size={18} /> },
  { title: "3D Camera & Layers", icon: <Box size={18} /> },
  { title: "Motion Systems for Design Systems", icon: <Layers size={18} /> },
  { title: "Mobile Gestures & Touch", icon: <Smartphone size={18} /> },
  { title: "Text Animators & Kinetic Type", icon: <Sparkles size={18} /> },
];

export default function App() {
  const [user, setUser] = useState(null);
  const [topics, setTopics] = useState([]);
  const [suggestions, setSuggestions] = useState([]);
  
  // Form states
  const [newTopic, setNewTopic] = useState("");
  const [newSuggestion, setNewSuggestion] = useState("");
  const [userName, setUserName] = useState("");
  const [activeTab, setActiveTab] = useState('topics'); // 'topics' or 'feedback'

  // --- Auth & Data Listeners ---
  useEffect(() => {
    // 1. Authenticate
    const initAuth = async () => {
      // In this environment, we usually just sign in anonymously for simplicity
      // unless a custom token is provided.
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        // If there's a token (rare in this specific snippet context but good practice), use it
        // Note: verify signInWithCustomToken is imported if used, otherwise fallback:
        await signInAnonymously(auth);
      } else {
        await signInAnonymously(auth);
      }
    };

    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;

    // 2. Listen to Topics
    // PATH: artifacts/{appId}/public/data/topics
    const topicsRef = collection(db, 'artifacts', appId, 'public', 'data', 'topics');
    const unsubscribeTopics = onSnapshot(topicsRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setTopics(data);
    }, (error) => console.error("Topics Error:", error));

    // 3. Listen to Suggestions/Questions
    // PATH: artifacts/{appId}/public/data/suggestions
    const suggestionsRef = collection(db, 'artifacts', appId, 'public', 'data', 'suggestions');
    const unsubscribeSuggestions = onSnapshot(suggestionsRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setSuggestions(data);
    }, (error) => console.error("Suggestions Error:", error));

    return () => {
      unsubscribeTopics();
      unsubscribeSuggestions();
    };
  }, [user]);

  // --- Actions ---

  const handleAddTopic = async (title) => {
    if (!title.trim() || !user) return;
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'topics'), {
        title: title.trim(),
        createdBy: user.uid,
        createdAt: serverTimestamp(),
        voters: [user.uid] // Auto-vote for your own creation
      });
      setNewTopic("");
    } catch (e) {
      console.error("Error adding topic:", e);
    }
  };

  const handleVote = async (topic) => {
    if (!user) return;
    const topicRef = doc(db, 'artifacts', appId, 'public', 'data', 'topics', topic.id);
    const hasVoted = topic.voters?.includes(user.uid);

    try {
      if (hasVoted) {
        await updateDoc(topicRef, {
          voters: arrayRemove(user.uid)
        });
      } else {
        await updateDoc(topicRef, {
          voters: arrayUnion(user.uid)
        });
      }
    } catch (e) {
      console.error("Error voting:", e);
    }
  };

  const handleAddSuggestion = async (e) => {
    e.preventDefault();
    if (!newSuggestion.trim() || !user) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'suggestions'), {
        text: newSuggestion.trim(),
        authorName: userName || "Anonymous Designer",
        createdBy: user.uid,
        createdAt: serverTimestamp(),
      });
      setNewSuggestion("");
    } catch (e) {
      console.error("Error adding suggestion:", e);
    }
  };

  const handleDeleteTopic = async (topicId) => {
    if (!user) return;
    // Simple admin check: in a real app, use security rules. 
    // Here we allow deletion if you created it or just for demo purposes anyone.
    // Let's restricting to creator for better UX.
    const topic = topics.find(t => t.id === topicId);
    if (topic && topic.createdBy === user.uid) {
        try {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'topics', topicId));
        } catch (e) { console.error(e); }
    }
  };

  // --- Derived State ---
  const sortedTopics = useMemo(() => {
    return [...topics].sort((a, b) => {
      const votesA = a.voters?.length || 0;
      const votesB = b.voters?.length || 0;
      return votesB - votesA; // Descending
    });
  }, [topics]);

  // Check if a preset is already in the list to avoid dupes
  const isPresetActive = (presetTitle) => {
    return topics.some(t => t.title.toLowerCase() === presetTitle.toLowerCase());
  };


  // --- UI ---
  
  if (!user) {
    return (
      <div className="min-h-screen bg-zinc-950 text-purple-200 flex items-center justify-center">
        <div className="animate-pulse flex flex-col items-center">
          <div className="h-12 w-12 bg-purple-600 rounded-lg mb-4 shadow-[0_0_30px_rgba(147,51,234,0.5)]"></div>
          <p>Initializing Workshop Hub...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 font-sans selection:bg-purple-500 selection:text-white">
      {/* Header */}
      <header className="bg-zinc-900/50 border-b border-zinc-800 backdrop-blur-md sticky top-0 z-10">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-purple-700 to-indigo-900 rounded-lg flex items-center justify-center shadow-lg shadow-purple-900/20 text-white font-bold text-xl">
              Ae
            </div>
            <div>
              <h1 className="font-bold text-lg leading-tight text-zinc-100">Workshop Planner</h1>
              <p className="text-xs text-zinc-400">For Product Design Team</p>
            </div>
          </div>
          
          <div className="flex bg-zinc-800 p-1 rounded-lg">
            <button 
              onClick={() => setActiveTab('topics')}
              className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'topics' ? 'bg-zinc-700 text-white shadow-sm' : 'text-zinc-400 hover:text-zinc-200'}`}
            >
              Curriculum
            </button>
            <button 
              onClick={() => setActiveTab('feedback')}
              className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${activeTab === 'feedback' ? 'bg-zinc-700 text-white shadow-sm' : 'text-zinc-400 hover:text-zinc-200'}`}
            >
              Q&A
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-8">
        
        {/* TOPICS TAB */}
        {activeTab === 'topics' && (
          <div className="space-y-12">
            
            {/* Intro / CTA */}
            <div className="bg-gradient-to-r from-purple-900/30 to-blue-900/10 rounded-2xl p-6 border border-purple-500/20">
              <h2 className="text-xl font-semibold mb-2 flex items-center gap-2">
                <Sparkles className="text-purple-400" size={20}/> 
                What do you want to learn?
              </h2>
              <p className="text-zinc-400 mb-6 text-sm max-w-2xl">
                Vote on the topics below that would be most useful for your daily work. 
                Feel free to add specific techniques or plugins you're curious about.
              </p>

              {/* Quick Add Presets */}
              <div className="flex flex-wrap gap-2">
                {PRESETS.map((preset) => (
                  <button
                    key={preset.title}
                    disabled={isPresetActive(preset.title)}
                    onClick={() => handleAddTopic(preset.title)}
                    className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium border transition-all
                      ${isPresetActive(preset.title) 
                        ? 'bg-zinc-800/50 border-zinc-800 text-zinc-500 cursor-default' 
                        : 'bg-zinc-900 border-zinc-700 text-purple-300 hover:border-purple-500 hover:bg-purple-900/20 active:scale-95'
                      }`}
                  >
                    {isPresetActive(preset.title) ? <Check size={12}/> : <Plus size={12}/>}
                    {preset.title}
                  </button>
                ))}
              </div>
            </div>

            {/* Voting List */}
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="text-sm font-bold text-zinc-500 uppercase tracking-wider">Topic Leaderboard</h3>
                <span className="text-xs text-zinc-600">{sortedTopics.length} topics</span>
              </div>

              {sortedTopics.length === 0 ? (
                <div className="text-center py-12 border-2 border-dashed border-zinc-800 rounded-xl">
                  <p className="text-zinc-500">No topics yet. Start by adding one!</p>
                </div>
              ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {sortedTopics.map((topic) => {
                    const votes = topic.voters?.length || 0;
                    const hasVoted = topic.voters?.includes(user.uid);
                    const isCreator = topic.createdBy === user.uid;

                    return (
                      <div 
                        key={topic.id} 
                        className={`relative group flex items-start justify-between p-4 rounded-xl border transition-all duration-200
                          ${hasVoted 
                            ? 'bg-purple-900/10 border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.1)]' 
                            : 'bg-zinc-900 border-zinc-800 hover:border-zinc-700'
                          }`}
                      >
                        <div className="flex-1 pr-4">
                          <h4 className={`font-medium ${hasVoted ? 'text-white' : 'text-zinc-300'}`}>
                            {topic.title}
                          </h4>
                          {votes > 0 && (
                            <div className="flex -space-x-1 mt-3">
                                {[...Array(Math.min(votes, 5))].map((_, i) => (
                                    <div key={i} className="w-5 h-5 rounded-full bg-zinc-700 border border-zinc-900 flex items-center justify-center text-[8px] text-zinc-400">
                                        <div className="w-2 h-2 rounded-full bg-purple-400/50"></div>
                                    </div>
                                ))}
                                {votes > 5 && (
                                    <div className="w-5 h-5 rounded-full bg-zinc-800 border border-zinc-900 flex items-center justify-center text-[9px] text-zinc-500">
                                        +
                                    </div>
                                )}
                            </div>
                          )}
                        </div>

                        <div className="flex flex-col items-end gap-2">
                            <button
                                onClick={() => handleVote(topic)}
                                className={`flex flex-col items-center justify-center w-12 h-12 rounded-lg transition-all active:scale-95
                                ${hasVoted 
                                    ? 'bg-purple-600 text-white shadow-lg' 
                                    : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700 hover:text-white'
                                }`}
                            >
                                <Vote size={18} />
                                <span className="text-xs font-bold mt-1">{votes}</span>
                            </button>
                            
                            {isCreator && (
                                <button 
                                    onClick={() => handleDeleteTopic(topic.id)}
                                    className="opacity-0 group-hover:opacity-100 p-1 text-zinc-600 hover:text-red-400 transition-opacity"
                                    title="Delete topic"
                                >
                                    <Trash2 size={14} />
                                </button>
                            )}
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>

            {/* Manual Add */}
            <div className="pt-8 border-t border-zinc-800">
              <h3 className="text-sm font-bold text-zinc-500 uppercase tracking-wider mb-4">Add Custom Topic</h3>
              <div className="flex gap-2">
                <input
                  type="text"
                  value={newTopic}
                  onChange={(e) => setNewTopic(e.target.value)}
                  onKeyDown={(e) => e.key === 'Enter' && handleAddTopic(newTopic)}
                  placeholder="e.g. Exporting JSON for iOS..."
                  className="flex-1 bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-zinc-200 placeholder-zinc-600 focus:outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 transition-all"
                />
                <button
                  onClick={() => handleAddTopic(newTopic)}
                  disabled={!newTopic.trim()}
                  className="bg-zinc-800 hover:bg-zinc-700 disabled:opacity-50 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center gap-2"
                >
                  <Plus size={18} />
                  Add
                </button>
              </div>
            </div>
          </div>
        )}

        {/* FEEDBACK TAB */}
        {activeTab === 'feedback' && (
          <div className="max-w-2xl mx-auto space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-300">
             <div className="text-center mb-8">
                <h2 className="text-2xl font-bold mb-2 text-white">Open Q&A</h2>
                <p className="text-zinc-400">Ask specific questions or suggest format ideas (e.g., "Can we do a session on Fridays?").</p>
             </div>

             <form onSubmit={handleAddSuggestion} className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl shadow-xl">
                <div className="mb-4">
                    <label className="block text-xs font-medium text-zinc-500 mb-1 uppercase">Your Name (Optional)</label>
                    <input 
                        type="text" 
                        value={userName}
                        onChange={(e) => setUserName(e.target.value)}
                        placeholder="Anonymous"
                        className="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-purple-500 transition-colors"
                    />
                </div>
                <div className="mb-4">
                    <label className="block text-xs font-medium text-zinc-500 mb-1 uppercase">Suggestion / Question</label>
                    <textarea 
                        value={newSuggestion}
                        onChange={(e) => setNewSuggestion(e.target.value)}
                        placeholder="I really struggle with..."
                        rows={3}
                        className="w-full bg-zinc-950 border border-zinc-800 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-purple-500 transition-colors resize-none"
                    />
                </div>
                <div className="flex justify-end">
                    <button 
                        type="submit"
                        disabled={!newSuggestion.trim()}
                        className="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <MessageSquarePlus size={16} />
                        Post Note
                    </button>
                </div>
             </form>

             <div className="space-y-4">
                {suggestions.length === 0 ? (
                    <div className="text-center text-zinc-600 py-8">No notes yet.</div>
                ) : (
                    suggestions
                        .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0))
                        .map(note => (
                        <div key={note.id} className="bg-zinc-900/50 border border-zinc-800 p-4 rounded-xl flex gap-4">
                            <div className="mt-1 min-w-[32px] min-h-[32px] w-8 h-8 rounded-full bg-gradient-to-br from-zinc-700 to-zinc-800 flex items-center justify-center text-xs font-bold text-zinc-400 border border-zinc-700">
                                {note.authorName.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="text-sm font-medium text-zinc-200">{note.authorName}</span>
                                    <span className="text-xs text-zinc-600">
                                        {note.createdAt ? new Date(note.createdAt.seconds * 1000).toLocaleDateString() : 'Just now'}
                                    </span>
                                </div>
                                <p className="text-zinc-400 text-sm leading-relaxed">{note.text}</p>
                            </div>
                        </div>
                    ))
                )}
             </div>
          </div>
        )}
      </main>
    </div>
  );
}
