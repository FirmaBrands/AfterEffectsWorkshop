<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>After Effects Workshop: Call for Topics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        ae: {
                            dark: '#161616',
                            panel: '#232323',
                            purple: '#9999FF',
                            accent: '#cf99ff',
                            text: '#cccccc'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0f0f11;
            color: #e0e0e0;
        }
        .ae-gradient {
            background: linear-gradient(135deg, #2d2d66 0%, #1e1e30 100%);
        }
        .checkbox-card:checked + label {
            border-color: #9999FF;
            background-color: rgba(153, 153, 255, 0.1);
            color: white;
        }
        .checkbox-card:checked + label .check-icon {
            opacity: 1;
            transform: scale(1);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #161616; 
        }
        ::-webkit-scrollbar-thumb {
            background: #444; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-sans">

    <!-- Navbar -->
    <nav class="border-b border-gray-800 bg-[#161616] sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-[#00005b] rounded flex items-center justify-center border border-[#9999FF] text-[#9999FF] font-bold text-sm shadow-[0_0_10px_rgba(153,153,255,0.3)]">
                    Ae
                </div>
                <h1 class="font-semibold text-lg tracking-tight text-white">Workshop <span class="text-gray-500 font-normal">Planner</span></h1>
            </div>
            <div class="text-xs text-gray-500" id="user-status">Connecting...</div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow p-4 md:p-8">
        <div class="max-w-3xl mx-auto">
            
            <!-- Header -->
            <header class="mb-10 text-center">
                <h2 class="text-3xl md:text-4xl font-bold text-white mb-3">What do you want to learn?</h2>
                <p class="text-gray-400 max-w-xl mx-auto">I'm organizing an After Effects workshop for the design team. Help me tailor the content to your needs and skill levels.</p>
            </header>

            <!-- Loading State -->
            <div id="loading-container" class="flex flex-col items-center justify-center py-20">
                <i class="fas fa-circle-notch fa-spin text-ae-purple text-3xl mb-4"></i>
                <p class="text-gray-500">Loading modules...</p>
            </div>

            <!-- View: Voting Form -->
            <form id="vote-form" class="hidden space-y-8 animate-fade-in opacity-0 transition-opacity duration-500">
                
                <!-- Section 1: Skill Level -->
                <section class="bg-[#1e1e1e] border border-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-layer-group text-ae-purple text-sm"></i> Current Comfort Level
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Beginner -->
                        <div class="relative">
                            <input type="radio" name="skill" id="skill_beginner" value="Beginner" class="peer sr-only" required>
                            <label for="skill_beginner" class="block p-4 bg-[#252525] border border-gray-700 rounded-lg cursor-pointer hover:bg-[#2a2a2a] peer-checked:border-ae-purple peer-checked:bg-[rgba(153,153,255,0.05)] transition-all">
                                <div class="text-ae-purple font-bold mb-1">Newbie</div>
                                <div class="text-xs text-gray-400">I've opened it once or twice, but it's scary.</div>
                            </label>
                        </div>
                        <!-- Intermediate -->
                        <div class="relative">
                            <input type="radio" name="skill" id="skill_intermediate" value="Intermediate" class="peer sr-only">
                            <label for="skill_intermediate" class="block p-4 bg-[#252525] border border-gray-700 rounded-lg cursor-pointer hover:bg-[#2a2a2a] peer-checked:border-ae-purple peer-checked:bg-[rgba(153,153,255,0.05)] transition-all">
                                <div class="text-ae-purple font-bold mb-1">Familiar</div>
                                <div class="text-xs text-gray-400">I can do keyframes and basic comps.</div>
                            </label>
                        </div>
                        <!-- Advanced -->
                        <div class="relative">
                            <input type="radio" name="skill" id="skill_advanced" value="Advanced" class="peer sr-only">
                            <label for="skill_advanced" class="block p-4 bg-[#252525] border border-gray-700 rounded-lg cursor-pointer hover:bg-[#2a2a2a] peer-checked:border-ae-purple peer-checked:bg-[rgba(153,153,255,0.05)] transition-all">
                                <div class="text-ae-purple font-bold mb-1">Pro</div>
                                <div class="text-xs text-gray-400">Teach me the dark magic (Expressions, Graph Editor).</div>
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Topics -->
                <section class="bg-[#1e1e1e] border border-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-white mb-2 flex items-center gap-2">
                        <i class="fas fa-list-check text-ae-purple text-sm"></i> Topics of Interest
                    </h3>
                    <p class="text-sm text-gray-500 mb-6">Select everything that sounds useful for your daily work.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="topics-container">
                        <!-- Topics injected via JS -->
                    </div>
                </section>

                <!-- Section 3: Open Suggestion -->
                <section class="bg-[#1e1e1e] border border-gray-800 rounded-xl p-6">
                    <h3 class="text-xl font-semibold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-comment-dots text-ae-purple text-sm"></i> Anything specific?
                    </h3>
                    <textarea id="suggestion-input" rows="3" class="w-full bg-[#161616] border border-gray-700 rounded-lg p-3 text-sm text-white focus:outline-none focus:border-ae-purple focus:ring-1 focus:ring-ae-purple transition-all placeholder-gray-600" placeholder="e.g. How do I export for dev handover? How to animate a logo?"></textarea>
                </section>

                <!-- Submit -->
                <div class="flex justify-end">
                    <button type="submit" class="bg-[#9999FF] hover:bg-[#8888ee] text-[#00005b] font-bold py-3 px-8 rounded-lg shadow-lg shadow-indigo-500/20 transform transition hover:-translate-y-0.5 active:translate-y-0">
                        Submit Preferences
                    </button>
                </div>
            </form>

            <!-- View: Results -->
            <div id="results-view" class="hidden space-y-8 animate-fade-in opacity-0 transition-opacity duration-500">
                
                <div class="bg-[#2a2a2a] border border-gray-700 rounded-lg p-6 text-center">
                    <div class="text-4xl mb-2">ðŸŽ‰</div>
                    <h3 class="text-xl font-bold text-white">Thanks for voting!</h3>
                    <p class="text-gray-400 text-sm">Here is what the team wants to learn so far.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Skill Breakdown -->
                    <div class="bg-[#1e1e1e] border border-gray-800 rounded-xl p-6">
                        <h4 class="text-gray-400 text-xs uppercase tracking-wider font-bold mb-4">Skill Distribution</h4>
                        <div id="skill-results" class="space-y-4">
                            <!-- Injected via JS -->
                        </div>
                    </div>

                    <!-- Top Topics -->
                    <div class="bg-[#1e1e1e] border border-gray-800 rounded-xl p-6">
                        <h4 class="text-gray-400 text-xs uppercase tracking-wider font-bold mb-4">Most Requested Topics</h4>
                        <div id="topic-results" class="space-y-3">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>

                <!-- Suggestions Feed -->
                <div class="bg-[#1e1e1e] border border-gray-800 rounded-xl p-6">
                    <h4 class="text-gray-400 text-xs uppercase tracking-wider font-bold mb-4">Specific Requests</h4>
                    <div id="suggestions-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <div class="text-center pt-6">
                     <button id="reset-btn" class="text-xs text-gray-600 hover:text-gray-400 underline">Edit my submission</button>
                </div>
            </div>

        </div>
    </main>

    <footer class="text-center py-6 text-xs text-gray-700">
        <p>Built for the Product Design Team</p>
    </footer>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Configuration ---
        const PRESET_TOPICS = [
            { id: "ui_anim", label: "UI Animation Principles (Easing, Timing)" },
            { id: "lottie", label: "Exporting to Lottie/Rive for Devs" },
            { id: "micro", label: "Micro-interactions & States" },
            { id: "graph", label: "Mastering the Graph Editor" },
            { id: "text", label: "Text Animation & Effects" },
            { id: "3d", label: "3D Layers & Cameras" },
            { id: "track", label: "Motion Tracking (Screen replacement)" },
            { id: "shortcuts", label: "Workflow & Shortcuts Speedrun" },
            { id: "mogrts", label: "Creating MOGRTs (Templates)" }
        ];

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyAubPtprKuQ_ky5AAboUbZHtu4AFbNVHqA",
            authDomain: "ae-workshop.firebaseapp.com",
            projectId: "ae-workshop",
            storageBucket: "ae-workshop.firebasestorage.app",
            messagingSenderId: "996938664906",
            appId: "1:996938664906:web:cc1277c3a33f0d93e59d33"
        };

        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Handle App ID logic for Preview Env or Production
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ae-workshop-production';
        const COLLECTION_NAME = 'workshop_responses';

        // State
        let currentUser = null;
        let hasVoted = false;

        // --- UI Elements ---
        const loadingContainer = document.getElementById('loading-container');
        const voteForm = document.getElementById('vote-form');
        const resultsView = document.getElementById('results-view');
        const topicsContainer = document.getElementById('topics-container');
        const userStatus = document.getElementById('user-status');

        // --- Initialization ---
        function init() {
            renderTopics();
            authenticate();
        }

        function renderTopics() {
            topicsContainer.innerHTML = PRESET_TOPICS.map(topic => `
                <div class="relative group">
                    <input type="checkbox" id="${topic.id}" name="topics" value="${topic.label}" class="checkbox-card peer sr-only">
                    <label for="${topic.id}" class="flex items-center justify-between p-4 bg-[#252525] border border-gray-700 rounded-lg cursor-pointer hover:bg-[#2a2a2a] transition-all h-full">
                        <span class="text-sm font-medium text-gray-300 peer-checked:text-white">${topic.label}</span>
                        <div class="check-icon w-5 h-5 rounded-full border border-gray-600 bg-[#1a1a1a] flex items-center justify-center opacity-50 transition-all text-[#9999FF]">
                            <i class="fas fa-check text-xs"></i>
                        </div>
                    </label>
                </div>
            `).join('');
        }

        async function authenticate() {
            // Check LocalStorage first to see if they voted in this browser session
            // This is a soft check for UX, the real check happens with Auth ID
            if(localStorage.getItem(`voted_${appId}`)) {
                hasVoted = true;
            }

            // Auth Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    userStatus.textContent = `ID: ${user.uid.slice(0,4)}...`;
                    checkDataAndShowView();
                    listenToResults(); // Start listening regardless of view
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Auth Failed", error);
                        userStatus.textContent = "Auth Error";
                    });
                }
            });
        }

        function checkDataAndShowView() {
            loadingContainer.classList.add('hidden');
            
            // In a real robust app, we'd check Firestore if this specific user doc exists
            // But relying on LocalStorage + the global vote check is sufficient for this scope
            if (hasVoted) {
                showResults();
            } else {
                showForm();
            }
        }

        function showForm() {
            voteForm.classList.remove('hidden');
            resultsView.classList.add('hidden');
            setTimeout(() => voteForm.classList.remove('opacity-0'), 50);
        }

        function showResults() {
            voteForm.classList.add('hidden');
            resultsView.classList.remove('hidden');
            setTimeout(() => resultsView.classList.remove('opacity-0'), 50);
        }

        // --- Data Handling ---

        // 1. Submit Vote
        voteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const formData = new FormData(voteForm);
            const skill = formData.get('skill');
            const topics = formData.getAll('topics');
            const suggestion = document.getElementById('suggestion-input').value;

            const voteData = {
                userId: currentUser.uid,
                skillLevel: skill,
                topics: topics,
                suggestion: suggestion,
                timestamp: serverTimestamp()
            };

            // UI Feedback
            const btn = voteForm.querySelector('button');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Saving...";
            btn.classList.add('opacity-70');

            try {
                // Using setDoc with userId to prevent duplicates efficiently
                // Path: artifacts/{appId}/public/data/{collectionName}/{docId}
                const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, currentUser.uid);
                
                await setDoc(userDocRef, voteData);
                
                // Set Local Flag
                localStorage.setItem(`voted_${appId}`, 'true');
                hasVoted = true;
                
                showResults();
            } catch (error) {
                console.error("Error writing document: ", error);
                alert("Something went wrong saving your vote. Check console.");
                btn.disabled = false;
                btn.innerText = originalText;
                btn.classList.remove('opacity-70');
            }
        });

        // 2. Listen to Results (Real-time)
        function listenToResults() {
            // Rule 1: Correct path
            // Rule 2: Simple query (fetch all)
            const q = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);

            onSnapshot(q, (snapshot) => {
                const votes = [];
                snapshot.forEach((doc) => {
                    votes.push(doc.data());
                });
                processAndRenderResults(votes);
            }, (error) => {
                console.error("Error listening to data:", error);
            });
        }

        // 3. Process Data & Render
        function processAndRenderResults(votes) {
            const skillCounts = { Beginner: 0, Intermediate: 0, Advanced: 0 };
            const topicCounts = {};
            const suggestions = [];

            PRESET_TOPICS.forEach(t => topicCounts[t.label] = 0);

            votes.forEach(vote => {
                // Count Skills
                if (skillCounts[vote.skillLevel] !== undefined) {
                    skillCounts[vote.skillLevel]++;
                }
                
                // Count Topics
                if (vote.topics && Array.isArray(vote.topics)) {
                    vote.topics.forEach(t => {
                        // Normalize key access
                        if (topicCounts[t] !== undefined) {
                            topicCounts[t]++;
                        } else {
                            // Handle topic name changes or custom topics if added later
                            topicCounts[t] = 1;
                        }
                    });
                }

                // Collect Suggestions
                if (vote.suggestion && vote.suggestion.trim().length > 0) {
                    suggestions.push(vote.suggestion);
                }
            });

            // --- Render Skills ---
            const totalVotes = votes.length || 1; // avoid divide by zero
            const skillHTML = Object.entries(skillCounts).map(([level, count]) => {
                const percent = Math.round((count / totalVotes) * 100);
                return `
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300">${level}</span>
                            <span class="text-ae-purple font-mono">${count}</span>
                        </div>
                        <div class="w-full bg-[#161616] rounded-full h-2">
                            <div class="bg-ae-purple h-2 rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('skill-results').innerHTML = skillHTML;

            // --- Render Topics ---
            const sortedTopics = Object.entries(topicCounts)
                .sort(([,a], [,b]) => b - a) // Sort by count descending
                .slice(0, 5); // Top 5

            const topicHTML = sortedTopics.map(([label, count]) => {
                const percent = Math.round((count / totalVotes) * 100);
                return `
                    <div class="group">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-300 truncate pr-4">${label}</span>
                            <span class="text-white font-bold text-xs bg-[#333] px-2 py-0.5 rounded">${count} votes</span>
                        </div>
                         <div class="w-full bg-[#161616] rounded-full h-1.5">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-1.5 rounded-full transition-all duration-1000" style="width: ${percent}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('topic-results').innerHTML = topicHTML || '<p class="text-gray-600 text-sm">No votes yet.</p>';

            // --- Render Suggestions ---
            const suggestionsHTML = suggestions.map(s => `
                <div class="bg-[#222] border-l-2 border-ae-purple p-3 rounded-r text-sm text-gray-300 italic">
                    "${s}"
                </div>
            `).join('');
            document.getElementById('suggestions-list').innerHTML = suggestionsHTML || '<div class="text-gray-600 text-sm col-span-2 text-center">No specific notes added.</div>';
        }

        // Reset for testing/editing
        document.getElementById('reset-btn').addEventListener('click', () => {
            showForm();
        });

        // Start
        init();
    </script>
</body>
</html>
